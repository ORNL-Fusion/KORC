name: spack
#on: [ push, workflow_dispatch ]

jobs:
  job_one:
    runs-on: ubuntu-latest
    steps:
      - name: grab main project
        uses: actions/checkout@v2

      - name: grab spack
        uses: actions/checkout@v2
        with:
          repository: spack/spack
          path: ./spack

      - name: spack cache
        id: spack-cache
        uses: actions/cache@v3
        with:
          path: ~/mirror
          key: spack-cache-1

      - if: ${{ steps.spack-cache.outputs.cache-hit != 'true' }}
        name: create spack cache
        run: |
          . ./spack/share/spack/setup-env.sh
          spack env activate -p -d ./
          spack add gcc@13.1.0
          spack install --no-cache
          spack load gcc@13.1.0
          spack compiler find

          spack add hdf5+fortran+mpi %gcc@13.1.0
          spack install --no-cache
          spack load hdf5+fortran+mpi %gcc@13.1.0

          spack mirror create -d ~/mirror --all
          spack env deactivate


      - name: build korc
        run: |
          . ./spack/share/spack/setup-env.sh
          spack env activate -p -d ./
          spack mirror add nacho ~/mirror
          spack mirror remove spack-public
          spack mirror list
          spack add
          spack install
          spack find
          set -x
          which cmake
          which gfortran
          gfortran --version
          set +x
          spack env deactivate
